<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crossword Editor</title>
<style>
  body{font-family:Arial,sans-serif;margin:0;background:#f7f7f7;color:#222;}
  header{background:#008080;color:#fff;padding:14px 10px;text-align:center;font-size:22px;font-weight:700;}
  .wrap{max-width:980px;margin:0 auto;padding:10px;}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0;}
  label{font-size:14px;font-weight:700;color:#333;}
  input[type="text"], input[type="number"], textarea{
    font-size:14px;padding:8px;border:1px solid #bbb;border-radius:8px;background:#fff;
  }
  input[type="number"]{width:78px;}
  textarea{width:100%;min-height:90px;resize:vertical;}
  button{
    background:#008080;color:#fff;border:none;border-radius:8px;
    padding:8px 12px;font-weight:700;font-size:14px;
  }
  button.secondary{
    background:#fff;color:#008080;border:1px solid #008080;
  }
  button:active{transform:translateY(1px);}

  .modebar button{padding:7px 10px;}
  .modebar button.active{background:#006a6a;}

  .gridwrap{display:flex;justify-content:center;overflow-x:auto;margin-top:8px;}
  table{border-collapse:collapse;user-select:none;}
  td{
    width:28px;height:28px;border:1px solid #999;position:relative;text-align:center;
    font-weight:700;font-size:16px;background:#fff;
  }
  @media (max-width:600px){ td{width:24px;height:24px;font-size:14px;} }
  @media (max-width:420px){ td{width:20px;height:20px;font-size:13px;} }

  td.block{background:#d8c178;}
  .num{position:absolute;top:1px;left:2px;font-size:9px;font-weight:700;}
  .draft{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    font-size:inherit;color:#111;
  }
  .sol{
    position:absolute;bottom:1px;right:2px;font-size:9px;color:#444;font-weight:700;
  }

  .cols2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  @media (max-width:800px){ .cols2{grid-template-columns:1fr;} }

  .cluebox{background:#fff;border:1px solid #ddd;border-radius:10px;padding:8px;}
  .cluebox h3{margin:4px 0 8px;color:#008080;}
  .cluerow{display:flex;gap:6px;align-items:center;margin:4px 0;}
  .cluerow span{width:40px;font-weight:700;}
  .cluerow input{flex:1;}

  .small{font-size:12px;color:#666;font-style:italic;}

  .exportbox{min-height:190px;font-family:monospace;font-size:12px;}

  .toast{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:18px;background:#008080;color:#fff;padding:8px 12px;border-radius:10px;
    font-size:13px;opacity:0;pointer-events:none;transition:opacity .25s;
  }
  .toast.show{opacity:1;}
</style>
</head>
<body>
<header>CROSSWORD EDITOR</header>

<div class="wrap">

  <div class="row">
    <label>Title</label>
    <input id="title" type="text" value="Daily Crossword" style="flex:1;min-width:200px">
    <label>Subtitle</label>
    <input id="subtitle" type="text" value="" style="flex:2;min-width:220px">
  </div>

  <div class="row">
    <label>Rows</label><input id="rows" type="number" min="5" max="25" value="17">
    <label>Cols</label><input id="cols" type="number" min="5" max="25" value="17">
    <button onclick="resizeGrid()">Resize Grid</button>
    <button class="secondary" onclick="autoNumber()">Auto-number Grid</button>
    <button class="secondary" onclick="refreshClueInputs()">Refresh Clue List</button>
  </div>

  <div class="row modebar">
    <button id="mBlocks" class="active" onclick="setMode('blocks')">Blocks</button>
    <button id="mNumbers" onclick="setMode('numbers')">Numbers</button>
    <button id="mDraft" onclick="setMode('draft')">Draft Letters</button>
    <button id="mSolution" onclick="setMode('solution')">Solution Letters</button>
    <span class="small">Tap squares to edit in the selected mode.</span>
  </div>

  <div class="row">
    <button class="secondary" onclick="exportJSON()">Export Puzzle + Solution</button>
    <button class="secondary" onclick="downloadJSON()">Download JSON</button>
    <button class="secondary" onclick="clearEditor()">Clear Editor</button>

    <input id="importFile" type="file" accept=".json,application/json" style="display:none" onchange="importFromFile(event)">
    <button onclick="document.getElementById('importFile').click()">Import JSON File</button>
    <button class="secondary" onclick="importFromPaste()">Import JSON (Paste)</button>
  </div>

  <div class="gridwrap">
    <table id="grid"></table>
  </div>

  <div class="cols2" style="margin-top:10px;">
    <div class="cluebox">
      <h3>Across Clues</h3>
      <div id="acrossClues"></div>
    </div>
    <div class="cluebox">
      <h3>Down Clues</h3>
      <div id="downClues"></div>
    </div>
  </div>

  <div class="row" style="margin-top:10px;">
    <label style="width:100%;">Paste JSON here (for Import Paste) / Export output below:</label>
    <textarea id="jsonBox" class="exportbox" placeholder="Paste puzzle.json here, or click Export to generate JSON."></textarea>
  </div>

</div>

<div id="toast" class="toast">Saved draft</div>

<script>
/* --------- STATE --------- */
let mode="blocks";
let R=17, C=17;

let grid=[];       // "#" or ""
let numbers=[];    // 0 or num
let draft=[];      // draft letters for creator view
let solution=[];   // solution letters for export

let across={};     // num -> clue
let down={};

const DRAFT_KEY="xwd-editor-draft";

/* --------- INIT --------- */
initEmpty(R,C);
renderAll();
restoreDraftIfExists();

/* Bind title/subtitle to autosave (FIX) */
document.getElementById("title").addEventListener("input", () => saveDraft(true));
document.getElementById("subtitle").addEventListener("input", () => saveDraft(true));

/* --------- MODE --------- */
function setMode(m){
  mode=m;
  ["mBlocks","mNumbers","mDraft","mSolution"].forEach(id=>{
    document.getElementById(id).classList.remove("active");
  });
  if(m==="blocks") document.getElementById("mBlocks").classList.add("active");
  if(m==="numbers") document.getElementById("mNumbers").classList.add("active");
  if(m==="draft") document.getElementById("mDraft").classList.add("active");
  if(m==="solution") document.getElementById("mSolution").classList.add("active");
}

/* --------- GRID INIT/RESIZE --------- */
function initEmpty(rows, cols){
  R=rows; C=cols;
  grid=Array.from({length:R},()=>Array.from({length:C},()=> ""));
  numbers=Array.from({length:R},()=>Array.from({length:C},()=> 0));
  draft=Array.from({length:R},()=>Array.from({length:C},()=> ""));
  solution=Array.from({length:R},()=>Array.from({length:C},()=> ""));
  across={}; down={};
}

function resizeGrid(){
  const nr=+document.getElementById("rows").value;
  const nc=+document.getElementById("cols").value;
  initEmpty(nr,nc);
  renderAll();
  saveDraft();
}

function clearEditor(){
  initEmpty(R,C);
  renderAll();
  saveDraft();
}

/* --------- RENDER --------- */
function renderAll(){
  renderGrid();
  refreshClueInputs();
}

function renderGrid(){
  const tbl=document.getElementById("grid");
  tbl.innerHTML="";
  for(let r=0;r<R;r++){
    const tr=document.createElement("tr");
    for(let c=0;c<C;c++){
      const td=document.createElement("td");
      if(grid[r][c]==="#") td.classList.add("block");

      if(numbers[r][c]>0){
        const n=document.createElement("div");
        n.className="num"; n.textContent=numbers[r][c];
        td.appendChild(n);
      }

      if(grid[r][c]!== "#"){
        const d=document.createElement("div");
        d.className="draft";
        d.textContent = draft[r][c] || "";
        td.appendChild(d);

        if(solution[r][c]){
          const s=document.createElement("div");
          s.className="sol";
          s.textContent=solution[r][c];
          td.appendChild(s);
        }
      }

      td.addEventListener("click",()=>onCellClick(r,c));
      tr.appendChild(td);
    }
    tbl.appendChild(tr);
  }
}

function onCellClick(r,c){
  if(mode==="blocks"){
    if(grid[r][c]==="#"){
      grid[r][c]="";
      numbers[r][c]=0;
      draft[r][c]="";
      solution[r][c]="";
    }else{
      grid[r][c]="#";
      numbers[r][c]=0;
      draft[r][c]="";
      solution[r][c]="";
    }
  }

  if(mode==="numbers"){
    if(grid[r][c]==="#") return;
    const current = numbers[r][c]||0;
    const val = prompt("Enter number (0 to clear):", current);
    if(val===null) return;
    const n = Math.max(0, parseInt(val,10)||0);
    numbers[r][c]=n;
  }

  if(mode==="draft"){
    if(grid[r][c]==="#") return;
    const current = draft[r][c]||"";
    const val = prompt("Draft letter (A-Z) or blank:", current);
    if(val===null) return;
    draft[r][c]=(val.trim().toUpperCase().slice(0,1).match(/[A-Z]/)||[""])[0];
  }

  if(mode==="solution"){
    if(grid[r][c]==="#") return;
    const current = solution[r][c]||"";
    const val = prompt("Solution letter (A-Z) or blank:", current);
    if(val===null) return;
    solution[r][c]=(val.trim().toUpperCase().slice(0,1).match(/[A-Z]/)||[""])[0];
  }

  renderAll();
  saveDraft();
}

/* --------- AUTO-NUMBER --------- */
function autoNumber(){
  numbers=Array.from({length:R},()=>Array.from({length:C},()=>0));
  let n=1;
  for(let r=0;r<R;r++){
    for(let c=0;c<C;c++){
      if(grid[r][c]==="#") continue;
      const startsAcross = (c===0||grid[r][c-1]==="#") && (c+1<C&&grid[r][c+1]!=="#");
      const startsDown   = (r===0||grid[r-1][c]==="#") && (r+1<R&&grid[r+1][c]!=="#");
      if(startsAcross || startsDown){
        numbers[r][c]=n++;
      }
    }
  }
  renderAll();
  saveDraft();
}

/* --------- CLUE INPUTS --------- */
function findClueStarts(){
  const acrossStarts=[], downStarts=[];
  for(let r=0;r<R;r++){
    for(let c=0;c<C;c++){
      if(grid[r][c]==="#") continue;
      const num = numbers[r][c];
      if(!num) continue;

      const startsAcross = (c===0||grid[r][c-1]==="#") && (c+1<C&&grid[r][c+1]!=="#");
      const startsDown   = (r===0||grid[r-1][c]==="#") && (r+1<R&&grid[r+1][c]!=="#");

      if(startsAcross) acrossStarts.push(num);
      if(startsDown) downStarts.push(num);
    }
  }
  acrossStarts.sort((a,b)=>a-b);
  downStarts.sort((a,b)=>a-b);
  return {acrossStarts, downStarts};
}

function refreshClueInputs(){
  const {acrossStarts, downStarts}=findClueStarts();
  const aDiv=document.getElementById("acrossClues");
  const dDiv=document.getElementById("downClues");
  aDiv.innerHTML=""; dDiv.innerHTML="";

  const oldAcross={...across};
  const oldDown={...down};
  across={}; down={};

  acrossStarts.forEach(num=>{
    across[num]=oldAcross[num]||"";
    const row=document.createElement("div");
    row.className="cluerow";
    row.innerHTML=`<span>${num}</span>`;
    const inp=document.createElement("input");
    inp.value=across[num];
    inp.oninput=()=>{across[num]=inp.value; saveDraft(true);};
    row.appendChild(inp);
    aDiv.appendChild(row);
  });

  downStarts.forEach(num=>{
    down[num]=oldDown[num]||"";
    const row=document.createElement("div");
    row.className="cluerow";
    row.innerHTML=`<span>${num}</span>`;
    const inp=document.createElement("input");
    inp.value=down[num];
    inp.oninput=()=>{down[num]=inp.value; saveDraft(true);};
    row.appendChild(inp);
    dDiv.appendChild(row);
  });
}

/* --------- EXPORT --------- */
function exportJSON(){
  // ALWAYS read current title/subtitle fields (FIX)
  const titleVal = document.getElementById("title").value || "Daily Crossword";
  const subtitleVal = document.getElementById("subtitle").value || "";

  const data={
    title: titleVal,
    subtitle: subtitleVal,
    rows:R, cols:C,
    grid: grid.map(row=>row.map(v=>v==="#"?"#":"")),
    numbers: numbers.map(row=>row.map(v=>v||0)),
    across:{...across},
    down:{...down},
    solution: solution.map((row,r)=>row.map((v,c)=>{
      if(grid[r][c]==="#") return "#";
      return (v||"");
    }))
  };

  const box=document.getElementById("jsonBox");
  box.value=JSON.stringify(data,null,2);
  showToast("Exported JSON");
  saveDraft(true);
}

function downloadJSON(){
  exportJSON();
  const text=document.getElementById("jsonBox").value;
  const blob=new Blob([text],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="puzzle.json";
  a.click();
  URL.revokeObjectURL(url);
}

/* --------- IMPORT --------- */
function importFromPaste(){
  const txt=document.getElementById("jsonBox").value.trim();
  if(!txt){ alert("Paste puzzle.json into the box first."); return; }
  try{
    const data=JSON.parse(txt);
    applyImported(data);
    showToast("Imported JSON");
  }catch(e){
    alert("That doesn't look like valid JSON.");
  }
}

function importFromFile(ev){
  const file=ev.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const data=JSON.parse(reader.result);
      applyImported(data);
      showToast("Imported JSON file");
    }catch(e){
      alert("JSON file couldn't be parsed.");
    }
  };
  reader.readAsText(file);
}

function applyImported(data){
  if(!data.rows||!data.cols||!data.grid||!data.numbers){
    alert("Missing required fields in JSON.");
    return;
  }

  // Force-load title/subtitle into fields (FIX)
  document.getElementById("title").value = data.title || "Daily Crossword";
  document.getElementById("subtitle").value = data.subtitle || "";

  document.getElementById("rows").value=data.rows;
  document.getElementById("cols").value=data.cols;

  R=data.rows; C=data.cols;

  grid = data.grid.map(row=>row.map(v=>v==="#"?"#":""));
  numbers = data.numbers.map(row=>row.map(v=>+v||0));

  solution = Array.from({length:R},()=>Array.from({length:C},()=> ""));
  if(Array.isArray(data.solution)){
    for(let r=0;r<R;r++){
      for(let c=0;c<C;c++){
        if(grid[r][c]==="#") continue;
        const v=data.solution[r]?.[c]||"";
        solution[r][c]=(v==="#"?"":String(v).toUpperCase().slice(0,1));
      }
    }
  }

  draft = Array.from({length:R},()=>Array.from({length:C},()=> ""));

  across = {...(data.across||{})};
  down   = {...(data.down||{})};

  renderAll();
  saveDraft(true); // persist imported title/subtitle too
}

/* --------- EDITOR AUTO-SAVE DRAFT --------- */
function saveDraft(silent=false){
  const draftObj={
    title:document.getElementById("title").value||"",
    subtitle:document.getElementById("subtitle").value||"",
    rows:R, cols:C,
    grid, numbers, draft, solution, across, down
  };
  localStorage.setItem(DRAFT_KEY, JSON.stringify(draftObj));
  if(!silent) showToast("Saved draft");
}

function restoreDraftIfExists(){
  const raw=localStorage.getItem(DRAFT_KEY);
  if(!raw) return;
  try{
    const d=JSON.parse(raw);
    if(!d.grid||!d.numbers) return;

    document.getElementById("title").value=d.title||"Daily Crossword";
    document.getElementById("subtitle").value=d.subtitle||"";
    document.getElementById("rows").value=d.rows||17;
    document.getElementById("cols").value=d.cols||17;

    R=d.rows; C=d.cols;
    grid=d.grid; numbers=d.numbers; draft=d.draft||draft; solution=d.solution||solution;
    across=d.across||{}; down=d.down||{};
    renderAll();
    showToast("Restored draft");
  }catch(e){}
}

/* --------- TOAST --------- */
let toastTimer=null;
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove("show"),1800);
}
</script>
</body>
</html>
